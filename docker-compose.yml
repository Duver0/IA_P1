# ⚕️ HUMAN CHECK - Configuración de Docker Compose
# Revisar puertos expuestos y variables de entorno antes de desplegar
services:
  producer:
    container_name: backend-producer
    build:
      context: ./backend/producer
      dockerfile: Dockerfile
    # ⚕️ HUMAN CHECK - Puertos Expuestos
    # Verificar que el puerto mapeado no entre en conflicto con otros servicios del host
    ports:
      - "${PRODUCER_PORT:-3000}:3000"
    # ⚕️ HUMAN CHECK - Volúmenes de Desarrollo (Hot-Reload)
    # Estos volúmenes montan el código fuente local para desarrollo con hot-reload.
    # En producción, eliminar estos volúmenes y usar la imagen construida.
    volumes:
      - ./backend/producer:/app
      - /app/node_modules
      - /app/dist
    environment:
      - NODE_ENV=development
      - PORT=3000
      # ⚕️ HUMAN CHECK - Credenciales de conexión RabbitMQ
      # No usar credenciales por defecto (guest/guest) en producción.
      # Configurar variables seguras en .env
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-turnos_queue}
    depends_on:
      - rabbitmq
    networks:
      - app-network

  consumer:
    container_name: backend-consumer
    build:
      context: ./backend/consumer
      dockerfile: Dockerfile
    # ⚕️ HUMAN CHECK - Volúmenes de Desarrollo (Hot-Reload)
    # Estos volúmenes montan el código fuente local para desarrollo con hot-reload.
    # En producción, eliminar estos volúmenes y usar la imagen construida.
    volumes:
      - ./backend/consumer:/app
      - /app/node_modules
      - /app/dist
    environment:
      - NODE_ENV=development
      # ⚕️ HUMAN CHECK - Credenciales de conexión RabbitMQ
      # No usar credenciales por defecto (guest/guest) en producción.
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-turnos_queue}
    depends_on:
      - rabbitmq
      - producer
    networks:
      - app-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "${FRONTEND_PORT:-3001}:3001"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://producer:3000
    depends_on:
      - producer
    networks:
      - app-network

  # ⚕️ HUMAN CHECK - Configuración de RabbitMQ
  # Cambiar credenciales por defecto antes de ir a producción
  rabbitmq:
    container_name: P1_rabbitmq
    image: rabbitmq:3-management-alpine
    # ⚕️ HUMAN CHECK - Puertos Expuestos de RabbitMQ
    # El puerto 15672 (Management UI) NO debe exponerse en producción
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MGMT_PORT:-15672}:15672"
    # ⚕️ HUMAN CHECK - Credenciales por defecto de RabbitMQ
    # Las credenciales guest/guest solo deben usarse en desarrollo local.
    # Usar secretos o variables de entorno seguras en producción.
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS:-guest}
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
