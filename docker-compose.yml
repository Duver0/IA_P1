# ⚕️ HUMAN CHECK - Configuración de Docker Compose
# Revisar puertos expuestos y variables de entorno antes de desplegar
services:
  producer:
    container_name: backend-producer
    build:
      context: ./backend/producer
      dockerfile: Dockerfile
      target: development
    # ⚕️ HUMAN CHECK - Comando de desarrollo
    # En producción, eliminar este command para usar el CMD del Dockerfile
    command: npm run start:dev
    # ⚕️ HUMAN CHECK - Puertos Expuestos
    # Verificar que el puerto mapeado no entre en conflicto con otros servicios del host
    ports:
      - "${PRODUCER_PORT:-3000}:3000"
    # ⚕️ HUMAN CHECK - Volúmenes de Desarrollo (Hot-Reload)
    # Estos volúmenes montan el código fuente local para desarrollo con hot-reload.
    # En producción, eliminar estos volúmenes y usar la imagen construida.
    volumes:
      - ./backend/producer:/app
      - /app/node_modules
      - /app/dist
    environment:
      - NODE_ENV=development
      - PORT=3000
      # ⚕️ HUMAN CHECK - Credenciales de conexión RabbitMQ
      # No usar credenciales por defecto (guest/guest) en producción.
      # Configurar variables seguras en .env
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-turnos_queue}
      # ⚕️ HUMAN CHECK - Cola de notificaciones (WebSocket bridge)
      - RABBITMQ_NOTIFICATIONS_QUEUE=${RABBITMQ_NOTIFICATIONS_QUEUE:-turnos_notifications}
      # ⚕️ HUMAN CHECK - Credenciales de conexión MongoDB (Lectura)
      - MONGODB_URI=mongodb://${MONGO_USER:-admin}:${MONGO_PASS:-admin123}@mongodb:27017/turnos_db?authSource=admin
    depends_on:
      - rabbitmq
      - mongodb
    networks:
      - app-network

  consumer:
    container_name: backend-consumer
    build:
      context: ./backend/consumer
      dockerfile: Dockerfile
      target: development
    # ⚕️ HUMAN CHECK - Comando de desarrollo
    # En producción, eliminar este command para usar el CMD del Dockerfile
    command: npm run start:dev
    # ⚕️ HUMAN CHECK - Volúmenes de Desarrollo (Hot-Reload)
    # Estos volúmenes montan el código fuente local para desarrollo con hot-reload.
    # En producción, eliminar estos volúmenes y usar la imagen construida.
    volumes:
      - ./backend/consumer:/app
      - /app/node_modules
      - /app/dist
    environment:
      - NODE_ENV=development
      # ⚕️ HUMAN CHECK - Credenciales de conexión RabbitMQ
      # No usar credenciales por defecto (guest/guest) en producción.
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-turnos_queue}
      # ⚕️ HUMAN CHECK - Cola de notificaciones (WebSocket bridge)
      - RABBITMQ_NOTIFICATIONS_QUEUE=${RABBITMQ_NOTIFICATIONS_QUEUE:-turnos_notifications}
      # ⚕️ HUMAN CHECK - Configuración del Scheduler
      - SCHEDULER_INTERVAL=${SCHEDULER_INTERVAL:-15000}
      - CONSULTORIOS_TOTAL=${CONSULTORIOS_TOTAL:-10}
      # ⚕️ HUMAN CHECK - Credenciales de conexión MongoDB
      # No usar credenciales por defecto en producción.
      - MONGODB_URI=mongodb://${MONGO_USER:-admin}:${MONGO_PASS:-admin123}@mongodb:27017/turnos_db?authSource=admin
    depends_on:
      - rabbitmq
      - producer
      - mongodb
    networks:
      - app-network

  frontend:
    container_name: frontend-app
    build:
      context: ./frontend
      dockerfile: Dockerfile
    # ⚕️ HUMAN CHECK - Comando de desarrollo
    # En producción, eliminar este command para usar el CMD del Dockerfile
    command: npm run dev -- -p 3001
    ports:
      - "${FRONTEND_PORT:-3001}:3001"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      # ⚕️ HUMAN CHECK - NEXT_PUBLIC_* se ejecutan en el NAVEGADOR del usuario, no en Docker
      # Por eso usan localhost (no el hostname interno 'producer')
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:3000
      # ⚕️ HUMAN CHECK - URL del WebSocket
      - NEXT_PUBLIC_WS_URL=http://localhost:3000
    depends_on:
      - producer
    networks:
      - app-network

  # ⚕️ HUMAN CHECK - Configuración de RabbitMQ
  # Cambiar credenciales por defecto antes de ir a producción
  rabbitmq:
    container_name: P1_rabbitmq
    image: rabbitmq:3-management-alpine
    # ⚕️ HUMAN CHECK - Puertos Expuestos de RabbitMQ
    # El puerto 15672 (Management UI) NO debe exponerse en producción
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MGMT_PORT:-15672}:15672"
    # ⚕️ HUMAN CHECK - Credenciales por defecto de RabbitMQ
    # Las credenciales guest/guest solo deben usarse en desarrollo local.
    # Usar secretos o variables de entorno seguras en producción.
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS:-guest}
    networks:
      - app-network

  # ⚕️ HUMAN CHECK - Configuración de MongoDB
  # Cambiar credenciales por defecto antes de ir a producción
  mongodb:
    container_name: P1_mongodb
    image: mongo:7
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    # ⚕️ HUMAN CHECK - Credenciales por defecto de MongoDB
    # Las credenciales admin/admin123 solo deben usarse en desarrollo local.
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASS:-admin123}
      - MONGO_INITDB_DATABASE=turnos_db
    volumes:
      - mongodb_data:/data/db
    networks:
      - app-network

volumes:
  mongodb_data:
    driver: local

networks:
  app-network:
    driver: bridge
